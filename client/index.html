<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Grafico Misurazioni O3</title>
  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    header {
      text-align: center;
    }
    .header-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .header-icons {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 1rem;
    }
  </style>
</head>
<body class="bg-gray-100">
  <header class="bg-gray-900 text-white py-6 px-4 mb-8">
    <div class="header-content">
      <h1 class="text-3xl font-bold mb-4">Grafico Misurazioni O3</h1>
      <div class="header-icons">
        <!-- Bottone per tornare alla home -->
        <button id="home-button" class="text-blue-300 hover:text-white mr-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"
            ></path>
          </svg>
        </button>
        <!-- Bottone per il link esterno -->
        <a
          href="https://www.jcmaxwell.edu.it/"
          target="_blank"
          rel="noopener noreferrer"
          class="text-blue-300 hover:text-white"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M19 14v5a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-5"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 14V3"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M5 9h14"
            ></path>
          </svg>
        </a>
      </div>
    </div>
  </header>
  <main class="flex flex-col items-center px-4">
    <!-- Sezione per il grafico -->
    <section
      id="chart-section"
      class="w-full max-w-4xl bg-white shadow-md rounded-lg p-6 mb-8 relative"
    >
      <!-- Icona del grafico -->
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-8 h-8 absolute top-0 left-0 transform -translate-x-1/2 -translate-y-1/2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25M9 16.5v.75m3-3v3M15 12v5.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"
        />
      </svg>
      <h2 class="text-2xl font-semibold mb-4 text-blue-900">
        Andamento Misurazioni O3
      </h2>
      <canvas id="chart" width="800" height="400"></canvas>
    </section>

    <!-- Sezione per i dati aggiuntivi -->
    <section
      id="additional-data-section"
      class="w-full max-w-4xl bg-white shadow-md rounded-lg p-6 relative"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-8 h-8 absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 12.75v-17.25c0-.621.504-1.125 1.125-1.125m-1.125 18c.621 0 1.125-.504 1.125-1.125m-15-17.25v1.5c0 .621.504 1.125 1.125 1.125m-1.125-18c-.621 0-1.125.504-1.125 1.125m1.125-1.125V3.375m0 17.25v1.5c0 .621-.504 1.125-1.125 1.125"
        />
      </svg>
      <h2 class="text-2xl font-semibold mb-4 text-blue-900">
        Dati Aggiuntivi
      </h2>
      <div id="additional-data" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Dati aggiuntivi verranno inseriti qui -->
      </div>
    </section>

    <!-- Sezione per la media più alta su 8 ore -->
    <section
      id="highest-8-hour-average-section"
      class="w-full max-w-4xl bg-white shadow-md rounded-lg p-6 mb-8 relative"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-8 h-8 absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 3v18m9-9H3"
        />
      </svg>
      <h2 class="text-2xl font-semibold mb-4 text-blue-900">
        Media più alta su 8 ore
      </h2>
      <div id="highest-8-hour-average" class="grid grid-cols-1 md:grid-cols-1 gap-4">
        <!-- Media più alta su 8 ore verrà inserita qui -->
      </div>
    </section>
  </main>
  <footer class="bg-gray-900 text-white py-6 text-center mt-8">
    <p class="text-xl">
      Un progetto realizzato con il supporto dell'Istituto JC Maxwell di
      Nichelino
    </p>
  </footer>
  <script>
    let chart; // WebSocket per ricevere i dati
    let ws = new WebSocket("ws://localhost:3000"); // Assicurati di sostituire "localhost:3000" con l'URL effettivo del tuo WebSocket
    ws.onopen = () => {
      console.log("Connessione WebSocket stabilita.");
    };
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      console.log("Dati ricevuti dal server:", data); // Estrai i dati di misurazione e le etichette di tempo
      const measurements = data.measurements;
      const labels = measurements.map((item) => item.Time);
      const values = measurements.map((item) => item.o3 * 2); // Aggiorna il grafico delle misurazioni
      if (chart) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = values;
        chart.update();
      } else {
        const ctx = document.getElementById("chart").getContext("2d");
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Valore O3",
                data: values,
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: { scales: { y: { beginAtZero: true } } },
        });
      } // Aggiorna i dati aggiuntivi
      updateAdditionalData(data); // Aggiorna la media più alta su 8 ore
      updateHighest8HourAverage(data.highest8HourAverage);
    };
    ws.onclose = () => {
      console.log("Connessione WebSocket chiusa.");
    }; // Funzione per aggiornare i dati aggiuntivi
    function updateAdditionalData(data) {
      const additionalDataSection =
        document.getElementById("additional-data");
      additionalDataSection.innerHTML = `
          <div class="p-4 border border-gray-300 rounded-lg">
            <h3 class="text-xl font-semibold mb-2">Superamenti 120 ng/m^3</h3>
            <p class="text-gray-600">Numero: ${
              data.exceedances120["120 superamenti"].length
            }</p>
            <p class="text-gray-600">Intervalli: ${data.exceedances120[
              "120 superamenti"
            ].join(", ")}</p>
          </div>
          <div class="p-4 border border-gray-300 rounded-lg">
            <h3 class="text-xl font-semibold mb-2">Superamenti 180 ng/m^3</h3>
            <p class="text-gray-600">Numero: ${
              data.exceedances180["180 superamenti"].length
            }</p>
            <p class="text-gray-600">Intervalli: ${data.exceedances180[
              "180 superamenti"
            ].join(", ")}</p>
          </div>
          <div class="p-4 border border-gray-300 rounded-lg">
            <h3 class="text-xl font-semibold mb-2">Superamenti 240 ng/m^3</h3>
            <p class="text-gray-600">Numero: ${
              data.exceedances240["240 superamenti"].length
            }</p>
            <p class="text-gray-600">Intervalli: ${data.exceedances240[
              "240 superamenti"
            ].join(", ")}</p>
          </div>
        `;
    } // Funzione per aggiornare la media più alta su 8 ore
    function updateHighest8HourAverage(highest8HourAverage) {
      const highest8HourAverageSection =
        document.getElementById("highest-8-hour-average");
      highest8HourAverageSection.innerHTML = `
          <div class="p-4 border border-gray-300 rounded-lg">
            <h3 class="text-xl font-semibold mb-2">Media più alta su 8 ore</h3>
            <p class="text-gray-600">Media: ${
              highest8HourAverage.average
            } ng/m^3</p>
            <p class="text-gray-600">Intervallo: ${
              highest8HourAverage.interval[0]+ highest8HourAverage.interval[7]
            }</p>
          </div>
        `;
    }
    // Aggiungi questo script per reindirizzare alla home quando il pulsante viene cliccato
    document
      .getElementById("home-button")
      .addEventListener("click", function () {
        window.location.href = "/home";
      });
  </script>
</body>
</html>
